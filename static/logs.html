<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GEX Dashboard - –õ–æ–≥–∏</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="/static/logs.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>–õ–æ–≥–∏ —Å–∏—Å—Ç–µ–º—ã</h1>
        </div>
        
        <nav class="nav">
            <a href="/" class="active">–ì–ª–∞–≤–Ω–∞—è</a>
            <a href="/logs">–õ–æ–≥–∏</a>
            <a href="/config">–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è</a>
            <a href="/rules">–ü—Ä–∞–≤–∏–ª–∞</a>
        </nav>

        <main>
            <div class="page-header">
                <h2>üìã –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ª–æ–≥–æ–≤ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</h2>
                <p>–ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ —Å–ª—É–∂–±—ã NFQ –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏</p>
            </div>

            <div class="controls">
                <div class="controls-left">
                    <button class="btn success" id="connectBtn" onclick="connectWebSocket()">
                        üîó –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è
                    </button>
                    <button class="btn danger" id="disconnectBtn" onclick="disconnectWebSocket()">
                        ‚ùå –û—Ç–∫–ª—é—á–∏—Ç—å—Å—è
                    </button>
                    <button class="btn" onclick="clearLogs()">
                        üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å
                    </button>
                    <button class="btn" onclick="downloadLogs()">
                        üíæ –°–∫–∞—á–∞—Ç—å
                    </button>
                </div>
                
                <div class="controls-right">
                    <div class="auto-scroll-toggle">
                        <span>–ê–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫–∞:</span>
                        <div class="toggle-switch active" id="autoScrollToggle" onclick="toggleAutoScroll()">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                    
                    <div class="log-stats">
                        <div class="stat-item">
                            <span>üìä</span>
                            <span id="logCount">0 —Å—Ç—Ä–æ–∫</span>
                        </div>
                    </div>
                    
                    <div class="status disconnected" id="status">
                        <div class="status-dot"></div>
                        <span>–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω</span>
                    </div>
                </div>
            </div>

            <div class="logs-container" id="logContainer">
                <div class="empty-state">
                    <h3>üîå –ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è</h3>
                    <p>–ù–∞–∂–º–∏—Ç–µ "–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è" –¥–ª—è –Ω–∞—á–∞–ª–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ª–æ–≥–æ–≤</p>
                </div>
            </div>
        </main>
    </div>

    <script>
        let ws = null;
        let isConnected = false;
        let autoScroll = true;
        let logCount = 0;
        let reconnectTimer = null;

        function updateStatus(status, message) {
            const statusElement = document.getElementById('status');
            const connectBtn = document.getElementById('connectBtn');
            const disconnectBtn = document.getElementById('disconnectBtn');
            
            statusElement.className = `status ${status}`;
            statusElement.innerHTML = `<div class="status-dot"></div><span>${message}</span>`;
            
            isConnected = (status === 'connected');
            connectBtn.disabled = isConnected;
            disconnectBtn.disabled = !isConnected;
        }

        function connectWebSocket() {
            if (isConnected) return;
            
            updateStatus('connecting', '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...');
            
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/logs`;
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = function() {
                console.log('WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω');
                updateStatus('connected', '–ü–æ–¥–∫–ª—é—á–µ–Ω');
                clearReconnectTimer();
            };
            
            ws.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    
                    if (data.type === 'initial_logs') {
                        clearLogs();
                        if (data.lines && data.lines.length > 0) {
                            data.lines.forEach(line => addLogLine(line, false));
                        }
                    } else if (data.type === 'logs') {
                        if (data.lines && data.lines.length > 0) {
                            data.lines.forEach(line => addLogLine(line, true));
                        }
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ WebSocket —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
                }
            };
            
            ws.onclose = function() {
                console.log('WebSocket –æ—Ç–∫–ª—é—á–µ–Ω');
                updateStatus('disconnected', '–û—Ç–∫–ª—é—á–µ–Ω');
                ws = null;
                
                scheduleReconnect();
            };
            
            ws.onerror = function(error) {
                console.error('WebSocket –æ—à–∏–±–∫–∞:', error);
                updateStatus('disconnected', '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
            };
        }

        function disconnectWebSocket() {
            if (ws) {
                ws.close();
                ws = null;
            }
            clearReconnectTimer();
            updateStatus('disconnected', '–û—Ç–∫–ª—é—á–µ–Ω');
        }

        function scheduleReconnect() {
            clearReconnectTimer();
            let countdown = 5;
            
            const updateCountdown = () => {
                updateStatus('disconnected', `–ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ ${countdown}—Å...`);
                countdown--;
                
                if (countdown < 0) {
                    connectWebSocket();
                } else {
                    reconnectTimer = setTimeout(updateCountdown, 1000);
                }
            };
            
            reconnectTimer = setTimeout(updateCountdown, 1000);
        }

        function clearReconnectTimer() {
            if (reconnectTimer) {
                clearTimeout(reconnectTimer);
                reconnectTimer = null;
            }
        }

        function addLogLine(line, isNew = false) {
            if (!line || typeof line !== 'string') return;
            
            const container = document.getElementById('logContainer');
            
            const emptyState = container.querySelector('.empty-state');
            if (emptyState) {
                container.removeChild(emptyState);
            }
            
            const logDiv = document.createElement('div');
            const timestamp = new Date().toLocaleTimeString();
            
            let logClass = 'log-line';
            if (isNew) logClass += ' new';
            
            if (line.toLowerCase().includes('error') || line.toLowerCase().includes('–æ—à–∏–±–∫–∞')) {
                logClass += ' error';
            } else if (line.toLowerCase().includes('warning') || line.toLowerCase().includes('–ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ')) {
                logClass += ' warning';
            } else if (line.toLowerCase().includes('info') || line.toLowerCase().includes('–∏–Ω—Ñ–æ')) {
                logClass += ' info';
            }
            
            logDiv.className = logClass;
            logDiv.innerHTML = `<span style="color: #6c757d; font-weight: 500;">[${timestamp}]</span> <span style="color: #212529; font-weight: 600;">${escapeHtml(line)}</span>`;
            
            container.appendChild(logDiv);
            logCount++;
            updateLogCount();
            
            if (autoScroll) {
                container.scrollTop = container.scrollHeight;
            }
            
            if (isNew) {
                setTimeout(() => {
                    logDiv.classList.remove('new');
                }, 3000);
            }
            
            const logLines = container.querySelectorAll('.log-line');
            if (logLines.length > 1000) {
                const excess = logLines.length - 1000;
                for (let i = 0; i < excess; i++) {
                    container.removeChild(logLines[i]);
                    logCount--;
                }
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function clearLogs() {
            const container = document.getElementById('logContainer');
            container.innerHTML = '<div class="empty-state"><h3>üìã –õ–æ–≥–∏ –æ—á–∏—â–µ–Ω—ã</h3><p>–û–∂–∏–¥–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö –∑–∞–ø–∏—Å–µ–π...</p></div>';
            logCount = 0;
            updateLogCount();
        }

        function downloadLogs() {
            const container = document.getElementById('logContainer');
            const logLines = container.querySelectorAll('.log-line');
            
            let content = '';
            logLines.forEach(line => {
                content += line.textContent + '\n';
            });
            
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `gex-logs-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            URL.revokeObjectURL(url);
        }

        function toggleAutoScroll() {
            autoScroll = !autoScroll;
            const toggle = document.getElementById('autoScrollToggle');
            toggle.classList.toggle('active', autoScroll);
        }

        function updateLogCount() {
            document.getElementById('logCount').textContent = `${logCount} —Å—Ç—Ä–æ–∫`;
        }

        window.addEventListener('load', function() {
            setTimeout(connectWebSocket, 500);
        });
        
        window.addEventListener('beforeunload', function() {
            disconnectWebSocket();
        });

        setInterval(() => {
            updateLogCount();
        }, 1000);
    </script>
</body>
</html>
